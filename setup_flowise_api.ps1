# ?????? ??? ???????? ???-?????? ????? API Flowise
$flowiseUrl = "http://localhost:3000"
$openaiApiKey = "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"

# ??????? ??? ?????????????? ? API
function Invoke-FlowiseAPI {
    param (
        [string]$Endpoint,
        [string]$Method = "GET",
        [object]$Body = $null
    )
    
    $apiUrl = "$flowiseUrl/api/v1/$Endpoint"
    
    $params = @{
        Uri = $apiUrl
        Method = $Method
        ContentType = "application/json"
    }
    
    if ($Body) {
        $jsonBody = $Body | ConvertTo-Json -Depth 10
        $params.Body = $jsonBody
    }
    
    try {
        $response = Invoke-RestMethod @params
        return $response
    }
    catch {
        Write-Host "?????? ??? ????????? ? API: $_" -ForegroundColor Red
        Write-Host "URL: $apiUrl" -ForegroundColor Red
        if ($Body) {
            Write-Host "Body: $($jsonBody)" -ForegroundColor Red
        }
        return $null
    }
}

# ???????? ??????? ?????? ??? OpenAI
Write-Host "???????? ??????? ?????? OpenAI..." -ForegroundColor Cyan
$credentialData = @{
    name = "OpenAI API Key"
    credentialType = "openai"
    plainDataObj = @{
        openAIApiKey = $openaiApiKey
    }
}

$credential = Invoke-FlowiseAPI -Endpoint "credentials" -Method "POST" -Body $credentialData

if (-not $credential) {
    Write-Host "?? ??????? ??????? ??????? ??????. ?????." -ForegroundColor Red
    exit
}

Write-Host "??????? ?????? ??????? ???????. ID: $($credential.id)" -ForegroundColor Green

# ???????? ???-??????
Write-Host "???????? ???-??????..." -ForegroundColor Cyan
$chatflowData = @{
    name = "RuslanAI Orchestrator"
    description = "???????? ???-????? ??? RuslanAI ? ?????????? ???????????"
}

$chatflow = Invoke-FlowiseAPI -Endpoint "chatflows" -Method "POST" -Body $chatflowData

if (-not $chatflow) {
    Write-Host "?? ??????? ??????? ???-?????. ?????." -ForegroundColor Red
    exit
}

Write-Host "???-????? ?????? ???????. ID: $($chatflow.id)" -ForegroundColor Green
Write-Host "URL ??? ??????? ? ??????: $flowiseUrl/canvas/$($chatflow.id)" -ForegroundColor Green

# ???????? ID ???-?????? ??? ????????????? ? Python-????????????
$configData = @"
# ???????????? Flowise ??? Python-????????????
FLOWISE_CHATFLOW_ID = "$($chatflow.id)"
FLOWISE_URL = "http://localhost:3000"
"@

$configData | Out-File -FilePath "C:\RuslanAI\flowise_config.py" -Encoding utf8
Write-Host "???????????? ????????? ? flowise_config.py" -ForegroundColor Green
