# Исправление проблем с WebSocket в RuslanAI

## Выполненные исправления

Мы внесли следующие изменения для устранения проблем с WebSocket соединением и модулями:

### 1. Исправление в websocketService.js

- Исправлен URL WebSocket соединения с `ws://localhost:8001/ws` на `ws://localhost:8005`, чтобы соответствовать порту, на котором запущен WebSocket мост `fixed_direct_bridge.py`
- Добавлены методы для типизированных обратных вызовов:
  - `addMessageCallback(type, callback)` - добавляет обработчик для сообщений определенного типа
  - `removeMessageCallback(type, callback)` - удаляет обработчик для сообщений определенного типа
- Улучшена обработка сообщений для вызова обработчиков соответствующих типов
- Сохранена обратная совместимость с существующими методами `onMessage` и `offMessage`
- Усовершенствован механизм переподключения

### 2. Исправление кодировки в RuslanAI.jsx

- Все закодированные кириллические сообщения были исправлены на корректный UTF-8 формат
- Исправлено приветственное сообщение: "Добро пожаловать в RuslanAI! Чем я могу вам помочь сегодня?"
- Исправлены все тексты сообщений и названия меток

### 3. Конфигурация Vite (vite.config.js)

- Обновлена конфигурация для правильной обработки модулей JavaScript
- Добавлены алиасы для директорий для лучшей резолюции модулей
- Установлены правильные заголовки для CORS и типов содержимого
- Настроены параметры сборки для корректной работы

### 4. Индексный HTML файл (index.html)

- Добавлены мета-теги для предотвращения кэширования
- Изменена ссылка на главный файл для предотвращения проблем с MIME-типами
- Добавлены явные указания типа модуля

## Как запустить систему

1. Запустите скрипт `run_fixed_system.ps1` из PowerShell:

```powershell
cd C:\RuslanAI\scripts
.\run_fixed_system.ps1
```

Это выполнит следующие действия:
- Проверит и создаст необходимые директории
- Остановит все процессы на используемых портах
- Проверит наличие и корректность исправленных файлов
- Запустит WebSocket мост на порту 8005
- Запустит API сервер на порту 8001
- Запустит веб-интерфейс через npm
- Откроет браузер с адресом http://localhost:3000

## Как проверить работу WebSocket соединения

Для прямой проверки WebSocket соединения вы можете открыть файл:
```
C:\RuslanAI\scripts\test_websocket_connection.html
```

Этот файл позволяет:
- Установить WebSocket соединение с сервером на порту 8005
- Отправлять тестовые сообщения
- Просматривать полученные ответы в реальном времени

## Возможные проблемы и их решение

### 1. Порт 8005 занят

Если порт 8005 уже используется другим процессом:
- Запустите PowerShell от имени администратора
- Выполните команду:
```powershell
Get-NetTCPConnection -LocalPort 8005 | Select-Object -Property OwningProcess,RemoteAddress,State
```
- Узнайте PID (OwningProcess) занимающего порт процесса
- Остановите процесс:
```powershell
Stop-Process -Id <PID> -Force
```

### 2. WebSocket не подключается

Проверьте, запущен ли WebSocket мост:
```powershell
Get-Process -Name python | Where-Object {$_.CommandLine -like "*fixed_direct_bridge.py*"}
```

Перезапустите мост вручную:
```powershell
cd C:\RuslanAI\scripts
python fixed_direct_bridge.py
```

### 3. Проблемы с npm

Очистите кэш npm:
```powershell
npm cache clean --force
```

Переустановите зависимости:
```powershell
cd C:\RuslanAI\web_ui
rm -r node_modules
npm install
```

## Обновления для разработчиков

При внесении изменений в websocketService.js или другие сервисы, необходимо следить за соблюдением следующих принципов:

1. URL WebSocket соединения должен соответствовать порту WebSocket моста (8005)

2. Интерфейс websocketService должен предоставлять следующие методы:
   - `connect()` - установка соединения
   - `disconnect()` - закрытие соединения
   - `sendMessage(message)` - отправка сообщения
   - `addMessageCallback(type, callback)` - добавление обработчика для типа сообщений
   - `removeMessageCallback(type, callback)` - удаление обработчика для типа сообщений
   - `onMessage(callback)` - добавление общего обработчика сообщений
   - `offMessage(callback)` - удаление общего обработчика сообщений

3. Все тексты должны быть в кодировке UTF-8 и не содержать закодированных кириллических символов