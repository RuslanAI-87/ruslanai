# RuslanAI - Режим Прямого API (без WebSocket)

## Обзор

Данный документ описывает режим работы без WebSocket, с прямым взаимодействием между веб-интерфейсом и центральным оркестратором через REST API. Это делает систему более надежной и простой в эксплуатации.

## Преимущества режима прямого API

1. **Упрощенная архитектура**: Удаление слоя WebSocket-коммуникации снижает сложность и устраняет потенциальные проблемы с соединением.
2. **Повышенная стабильность**: Меньше компонентов - меньше точек отказа.
3. **Улучшенная отладка**: Более прозрачное взаимодействие, легче отслеживать запросы/ответы.
4. **Совместимость с стандартными веб-серверами**: Работает с обычными прокси и балансировщиками нагрузки.
5. **Меньше ресурсов**: Не требуется поддерживать постоянные соединения.

## Реализованные изменения

### Серверная часть

1. Создан новый файл `direct_api.py`, который содержит облегченную версию API без WebSocket.
2. Все эндпоинты возвращают ответы напрямую, без асинхронных уведомлений.
3. Сохранена полная совместимость с существующим оркестратором (`central_orchestrator.py`).
4. Добавлены расширенные заголовки для правильной кодировки UTF-8.

### Клиентская часть

1. Обновлен `agentService.js` для прямой коммуникации с API без использования WebSocket.
2. Компонент `RuslanAI.jsx` модифицирован для работы без WebSocket-событий.
3. Добавлены механизмы отображения статуса соединения и автоматических повторных попыток при ошибках.
4. Сохранена вся функциональность пользовательского интерфейса.

## Архитектура системы

```
┌────────────────┐      HTTP/REST      ┌────────────────┐
│   Web UI       │ -----------------> │  Direct API    │
│   (React)      │ <----------------- │   Server       │
└────────────────┘                    └────────┬───────┘
                                              │
                                              │
                                              v
                                     ┌────────────────┐
                                     │   Central      │
                                     │  Orchestrator  │
                                     └────────────────┘
```

## Файлы и компоненты

### Серверная часть

- **`/central_agent/backend/direct_api.py`**: Основной файл API сервера без WebSocket
- **`/scripts/start_direct_api.bat`**: Скрипт для запуска API сервера
- **`/scripts/verify_direct_api.py`**: Скрипт для проверки работоспособности API
- **`/scripts/verify_direct_api.bat`**: Запускает скрипт проверки из командной строки Windows

### Клиентская часть

- **`/web_ui/src/services/agentService.js`**: Сервис для коммуникации с API
- **`/web_ui/src/components/RuslanAI.jsx`**: Основной компонент пользовательского интерфейса
- **`/scripts/update_direct_mode.bat`**: Скрипт для перехода на режим прямого API

## Использование

### Запуск системы

1. **Активация режима прямого API**:
   ```
   C:\RuslanAI\scripts\update_direct_mode.bat
   ```
   Это сделает резервные копии существующих файлов и заменит их на версии для прямого API.

2. **Запуск API сервера**:
   ```
   C:\RuslanAI\scripts\start_direct_api.bat
   ```
   Запустит сервер на порту 8001.

3. **Запуск веб-интерфейса**:
   Используйте стандартный скрипт запуска веб-интерфейса.

4. **Проверка работоспособности API**:
   ```
   C:\RuslanAI\scripts\verify_direct_api.bat
   ```
   Проверит доступность API и выполнит тестовые запросы.

### API эндпоинты

- **`/api/health`**: Проверка статуса API сервера
  - Метод: GET
  - Ответ: `{"status": "ok", "message": "API сервер работает в режиме прямых запросов (без WebSocket)"}`

- **`/orchestrator/central`**: Основной эндпоинт для взаимодействия с оркестратором
  - Метод: POST
  - Тело запроса: `text` (сообщение), `userId` (ID пользователя, опционально)
  - Ответ: `{"response": "ответ от оркестратора", "status": "completed", "userId": "id_пользователя"}`

- **`/api/chat`**: Альтернативный эндпоинт для запросов через JSON
  - Метод: POST
  - Тело запроса: JSON с `message` и `userId` (опционально)
  - Ответ: JSON с полем `response` и `chat_id`

- **`/api/execute_code`**: Эндпоинт для выполнения кода
  - Метод: POST
  - Тело запроса: JSON с `code` и `language` (опционально)
  - Ответ: JSON с результатом выполнения

## Отладка и устранение проблем

### Логи

- **API сервер**: `C:/RuslanAI/logs/direct_api.log`
- **Центральный оркестратор**: `C:/RuslanAI/logs/central_agent.log`

### Частые проблемы

1. **API сервер не запускается**:
   - Проверьте доступность порта 8001
   - Убедитесь, что Python и все зависимости установлены
   - Проверьте права доступа к директориям и файлам логов

2. **Нет ответа от API**:
   - Проверьте, что сервер запущен
   - Проверьте логи на наличие ошибок
   - Убедитесь, что запрос формируется правильно

3. **Ошибки кодировки в ответах**:
   - Проверьте наличие правильных заголовков Content-Type с указанием charset=utf-8

## Возвращение к предыдущей версии

Если вам необходимо вернуться к режиму с WebSocket:

1. Восстановите файлы из резервных копий:
   ```
   copy C:\RuslanAI\web_ui\src\components\RuslanAI.jsx.bak_websocket C:\RuslanAI\web_ui\src\components\RuslanAI.jsx
   copy C:\RuslanAI\web_ui\src\services\agentService.js.bak_websocket C:\RuslanAI\web_ui\src\services\agentService.js
   ```

2. Запустите WebSocket сервер и стандартный API.