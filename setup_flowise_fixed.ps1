# setup_flowise_fixed.ps1
# ?????? ??? ?????????????? ????????? ??????? ? Flowise

# ?????????
$flowiseUrl = "http://localhost:3000"
$apiUrl = "$flowiseUrl/api/v1"

# ??????? ??? ?????????? HTTP-????????
function Invoke-FlowiseApi {
    param (
        [string]$Endpoint,
        [string]$Method = "GET",
        [object]$Body = $null,
        [string]$ContentType = "application/json"
    )
    
    $fullUrl = "$apiUrl/$Endpoint"
    $params = @{
        Uri = $fullUrl
        Method = $Method
        ContentType = $ContentType
    }
    
    if ($Body -ne $null) {
        if ($Body -is [string]) {
            $params.Body = $Body
        } else {
            $params.Body = $Body | ConvertTo-Json -Depth 10
        }
    }
    
    try {
        $response = Invoke-RestMethod @params
        return $response
    } catch {
        Write-Host "?????? ??? ?????? API: $_" -ForegroundColor Red
        Write-Host "URL: $fullUrl" -ForegroundColor Red
        Write-Host "?????: $Method" -ForegroundColor Red
        if ($Body -ne $null) {
            Write-Host "???? ???????: $($params.Body)" -ForegroundColor Red
        }
        return $null
    }
}

# ????????? ??????????? Flowise
Write-Host "???????? ??????????? Flowise API..." -ForegroundColor Cyan
try {
    $healthCheck = Invoke-RestMethod -Uri "$apiUrl/health"
    Write-Host "Flowise ???????? ? ????????." -ForegroundColor Green
} catch {
    Write-Host "Flowise ??????????. ?????????, ??? ?????? ??????? ?? $flowiseUrl" -ForegroundColor Red
    Write-Host "??????: $_" -ForegroundColor Red
    exit
}

# ????????? ?????? ????????? ???????????
Write-Host "????????? ?????? ???????????..." -ForegroundColor Cyan
$components = Invoke-FlowiseApi -Endpoint "components"
if ($components -eq $null) {
    Write-Host "?? ??????? ???????? ?????? ???????????. ?????." -ForegroundColor Red
    exit
}
Write-Host "???????? ???????????: $($components.Count)" -ForegroundColor Green

# ??????? credential ??? OpenAI ??? ??????
Write-Host "???????? ??????? ?????? OpenAI..." -ForegroundColor Cyan
$credentialName = "OpenAI API Key"
$credentials = Invoke-FlowiseApi -Endpoint "credentials"

# ?????????, ?????????? ?? ??? ????? credential
$openAiCredential = $credentials | Where-Object { $_.name -eq $credentialName }

if ($openAiCredential -eq $null) {
    # ?????? API ????? ? ????????????
    $apiKey = Read-Host "??????? ??? OpenAI API ????"
    
    $credentialData = @{
        name = $credentialName
        credentialType = "openai"
        plainDataObj = @{
            openAIApiKey = $apiKey
        }
    }
    
    $newCredential = Invoke-FlowiseApi -Endpoint "credentials" -Method "POST" -Body $credentialData
    if ($newCredential -eq $null) {
        Write-Host "?? ??????? ??????? ??????? ?????? OpenAI. ?????." -ForegroundColor Red
        exit
    }
    $openAiCredential = $newCredential
    Write-Host "??????? ?????? OpenAI ??????? ???????. ID: $($openAiCredential.id)" -ForegroundColor Green
} else {
    Write-Host "??????? ?????? OpenAI ??? ??????????. ID: $($openAiCredential.id)" -ForegroundColor Green
}

# ??????? ????? chatflow
Write-Host "???????? ?????? ???-??????..." -ForegroundColor Cyan
$chatflowData = @{
    name = "RuslanAI Orchestrator"
    description = "???????? ???-????? ??? RuslanAI ? ?????????? ??????????? ? ????????????? ????"
}

$chatflow = Invoke-FlowiseApi -Endpoint "chatflows" -Method "POST" -Body $chatflowData
if ($chatflow -eq $null) {
    Write-Host "?? ??????? ??????? ???-?????. ?????." -ForegroundColor Red
    exit
}
Write-Host "???-????? ?????? ???????. ID: $($chatflow.id)" -ForegroundColor Green

# ????????? ?????????
Write-Host "`n===== ????????? Flowise ????????? ??????? =====`n" -ForegroundColor Green
Write-Host "???-????? 'RuslanAI Orchestrator' ?????? ? ID: $($chatflow.id)" -ForegroundColor Cyan
Write-Host "?????? ?? ?????? ????????? ??? ????? ????????? Flowise: $flowiseUrl/canvas/$($chatflow.id)" -ForegroundColor Cyan
Write-Host "API ???????? ???-??????: $flowiseUrl/api/v1/prediction/$($chatflow.id)" -ForegroundColor Cyan
Write-Host "`n??????? ID ???-?????? ? ??? Python-?????????? ??? ?????? ? ?????????????:" -ForegroundColor Yellow
Write-Host "orchestrator = FlowiseOrchestrator(chatflow_id='$($chatflow.id)')" -ForegroundColor Yellow
